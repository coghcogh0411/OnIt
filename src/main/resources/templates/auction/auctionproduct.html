<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒí’ˆ ìƒì„¸ í˜ì´ì§€</title>
  <link rel="stylesheet" href="/css/resaleproduct.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bxslider@4.2.17/dist/jquery.bxslider.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bxslider@4.2.17/dist/jquery.bxslider.min.js"></script>
  <script type="text/javascript" src="/js/move.js"></script>
  <script
    src="http://sd-beanmouse.duckdns.org:43218/socket.io/socket.io.js"></script>
  <script>
    $(function() {
      $(".seller-info").click(function() {
        $(".sub-buttons").toggleClass("show");
      });
      $('.slider').bxSlider({
        captions : true
      });
      
      
      
      var socket = io.connect("http://sd-beanmouse.duckdns.org:43218");

      socket.on("connect", function() {
        console.log("âœ… ì†Œì¼“ ì—°ê²° ì„±ê³µ!");
      });

      socket.on("connect_error", function(error) {
        console.error("âŒ ì†Œì¼“ ì—°ê²° ì‹¤íŒ¨!", error);
      });

      $(".bid-button").click(function() {
        var cost = $(".auction-cost").val();
        var username = $(".user").text(); // íŒë§¤ì ì´ë¦„ì„ ì‚¬ìš© (ì‚¬ìš©ì ì •ë³´ë¡œ ìˆ˜ì • ê°€ëŠ¥)
        var auctionNo = $(".auctionNo").val();
        
        console.log("ğŸ’° ì…ì°° ì‹œë„: " + cost + ", ì‚¬ìš©ì: " + username + " / ê²½ë§¤ë²ˆí˜¸: " + auctionNo);

        // ì„œë²„ë¡œ ì…ì°° ì •ë³´ ì „ì†¡
        socket.emit("bid", { auctionNo: auctionNo, amount: cost, username: username });
      });

      socket.on("updateBids", function(bids) {
        var pageAuctionNo = $(".auctionNo").val();
        
        // ì…ì°° ëª©ë¡ ìƒˆë¡œê³ ì¹¨: ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
        $(".bidder-list").empty();
        
     	// ì„œë²„ë¡œë¶€í„° ë°›ì€ ì…ì°° ëª©ë¡(data.bids)ì—ì„œ í˜„ì¬ í˜ì´ì§€ ê²½ë§¤ë²ˆí˜¸ì™€ ì¼ì¹˜í•˜ëŠ” í•­ëª©ë§Œ í‘œì‹œ
        bids.forEach(function(bid) {
          console.log(bid);
          if (bid.auctionNo.no == pageAuctionNo) {
              // auctionNoì˜ no, userì˜ nickname, amount ì €ì¥
              var auctionNo = bid.auctionNo.no;
              var nickname = bid.user.nickname;
              var amount = bid.amount;

              console.log("ê²½ë§¤ ë²ˆí˜¸:", auctionNo);
              console.log("ì…ì°°ì ë‹‰ë„¤ì„:", nickname);
              console.log("ì…ì°° ê¸ˆì•¡:", amount);
              
              // ì—¬ê¸°ì— í•´ë‹¹ ì…ì°° ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” ë¡œì§ ì¶”ê°€
              
              // ì…ì°°ì ì´ë¦„ê³¼ ì…ì°° ê¸ˆì•¡ í‘œì‹œ
              var name = $("<span></span>").text(bid.user.name);
              var amount = $("<span></span>").text(bid.amount + "ì›");
              var li = $("<li></li>").append(name, " ", amount);
              $(".bidder-list").append(li);
            }
        });
        
      });
    });
  </script>
</head>
<body>
  <div class="main-content">
    <div class="content-area">
      <div class="product-detail">
        <div class="image-gallery">
          <div class="slider">
            <div th:each="p : ${photos}">
              <img th:src="|/HoMini/Img/${p.url}|" alt="ìƒí’ˆ ì´ë¯¸ì§€"
                   class="sliderImg" />
            </div>
          </div>
        </div>

        <div class="seller-info">
          <div class="seller-profile">
            <img src="/placeholder.svg?height=40&width=40" alt="í”„ë¡œí•„"
                 class="profile-image">
            <div class="seller-name"
                 th:text="${product.user != null ? product.user.nickname : 'íŒë§¤ì'}"></div>
            <div class="rating">â­â­â­â­â­</div>
            <button class="like-button">â™¡</button>
          </div>
          <div class="sub-buttons">
            <a href="/#" class="sub-button">ì •ë³´ë³´ê¸°</a>
            <a href="#" class="sub-button chat-btn">1:1ìª½ì§€ ë³´ë‚´ê¸°</a>
            <a href="#" class="sub-button">íŒ”ë¡œìš°</a>
          </div>
        </div>

        <div class="product-info">
          <h1 class="product-title" th:text="${product.title}">ì œëª©</h1>
          <div class="meta-info">
            <span class="date"
                  th:text="${#dates.format(product.date, 'yyyy-MM-dd HH:mm')}"></span>
          </div>

          <div class="price" th:text="${#lists.isEmpty(bidList) ? product.price : bidList[0].amount} + ' ì›'"></div>

          <div class="description-box">
            <textarea class="description-textarea" readonly
                      th:utext="${product.description}"></textarea>
          </div>

          <div class="action-buttons">
            <button class="action-button" th:if="${product.deal == 'ê°€ëŠ¥'}">ëŒ“ê¸€ ê°€ëŠ¥</button>
            <button class="action-button" th:if="${product.delivery == 'ê°€ëŠ¥'}">ì§ê±°ë˜ ê°€ëŠ¥</button>
          </div>
        </div>
        <div class="auction-section">
          <div class="bidders">
            <h3>ğŸ† ì…ì°°ì ëª…ë‹¨</h3>
            <ul class="bidder-list">
              <li th:each="b:${bidList}">
                <span th:text="${b.user.name}"></span>
                <span th:text="${b.amount+' ì›'}"></span>
              </li>
            </ul>
          </div>
        </div>
        <div>
          <form action="/auction-bid">
            <input class="auctionNo" name="auctionNo" type="hidden" th:value="${product.no}">
            <div class="auction-bid">
              <h3>
                ê²½ë§¤ ì‹œì‘ê°€ <strong th:text="${product.price + ' ì›'}"></strong>
              </h3>
              <div class="bid-options">
                <button class="bid-option">+@ ì›</button>
                <button class="bid-option">+@ ì›</button>
                <button class="bid-option">+@ ì›</button>
                <button class="bid-option">+@ ì›</button>
              </div>
              <div class="bid-input">
                <input class="auction-cost" name="amount" type="text" th:value="${#lists.isEmpty(bidList) ? product.price : bidList[0].amount}">
                <button class="bid-button" type="submit">ì…ì°°í•˜ê¸°</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
